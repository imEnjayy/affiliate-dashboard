<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Top 25 Wins — GamblePnl</title>
  <style>
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui;background:#0d1117;color:#e6edf3}
    .wrap{max-width:1000px;margin:30px auto;padding:20px}
    h1{font-size:24px;margin-bottom:12px}
    input[type=file]{padding:6px;border:1px dashed #555;border-radius:6px;background:#161b22;color:#aaa}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:8px 10px;text-align:left;font-size:14px}
    th{background:#161b22;color:#aaa}
    tr:nth-child(even){background:#161b22}
    .positive{color:#10b981;font-weight:600}
    .small{font-size:13px;color:#888}
    .lead{color:#aaa;font-size:14px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Top 25 Wins</h1>
  <p class="lead">Upload your bet archive JSON files. The table will show your 25 biggest wins.</p>
  <input id="fileInput" type="file" accept="application/json" multiple />

  <table id="winsTable" style="display:none">
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Game</th>
        <th>Stake</th>
        <th>Payout</th>
        <th>Profit</th>
        <th>Multiplier</th>
        <th>Currency</th>
      </tr>
    </thead>
    <tbody id="winsBody"></tbody>
  </table>
</div>

<script>
const LS_KEY = "gambles:records:v2";

function parseDate(val){
  if (!val) return null;
  if (typeof val === "number"){
    return new Date(val > 1e12 ? val : val*1000);
  }
  const d = new Date(val);
  return isNaN(d) ? null : d;
}

function normalizeRecord(raw){
  const d = raw.data || {};
  const stake = Number(d.amount||0);
  const payout = Number(d.payout||0);
  const profit = payout - stake;
  const dateObj = parseDate(d.createdAt) || parseDate(raw.created_at);
  return {
    game: d.gameName || "Unknown",
    stake,
    payout,
    profit,
    multiplier: d.payoutMultiplier || null,
    currency: d.currency || "",
    date: dateObj ? dateObj.toISOString() : null,
    raw
  };
}

function renderTopWins(records){
  const wins = records.filter(r => r.profit > 0)
                      .sort((a,b)=> b.profit - a.profit)
                      .slice(0,25);
  const tbody = document.getElementById("winsBody");
  tbody.innerHTML = "";
  wins.forEach((w,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${w.date ? new Date(w.date).toLocaleString() : "—"}</td>
      <td>${w.game}</td>
      <td>${w.stake.toFixed(6)}</td>
      <td>${w.payout.toFixed(6)}</td>
      <td class="positive">${w.profit.toFixed(6)}</td>
      <td>${w.multiplier ? w.multiplier.toFixed(2)+"x" : "—"}</td>
      <td>${w.currency}</td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById("winsTable").style.display = wins.length ? "table" : "none";
}

document.getElementById("fileInput").addEventListener("change", async ev=>{
  const files = ev.target.files;
  if (!files.length) return;
  const parsed = [];
  for (const f of files){
    try{
      const txt = await f.text();
      const json = JSON.parse(txt);
      const arr = Array.isArray(json) ? json : (json.data ? [json] : (json.bets||json.records||[]));
      arr.forEach(item => parsed.push(normalizeRecord(item)));
    }catch(e){console.error("Parse fail", f.name, e);}
  }
  localStorage.setItem(LS_KEY, JSON.stringify(parsed));
  renderTopWins(parsed);
});

// load from localStorage on startup
const saved = localStorage.getItem(LS_KEY);
if (saved){
  try{ renderTopWins(JSON.parse(saved)); }catch(e){}
}
</script>
</body>
</html>
