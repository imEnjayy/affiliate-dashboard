<script>
document.addEventListener("DOMContentLoaded", () => {
  const LS_KEY = "gambles:records:v7";

  function parseDate(val){
    if (!val) return null;
    if (typeof val === "number"){
      return new Date(val > 1e12 ? val : val*1000);
    }
    const d = new Date(val);
    return isNaN(d) ? null : d;
  }

  function normalizeRecord(raw){
    const d = raw.data || {};
    const stake = Number(d.amount || 0);
    const payout = Number(d.payout || 0);
    const profit = payout - stake;
    const dateObj = parseDate(d.createdAt) || parseDate(raw.created_at);
    return {
      game: d.gameName || "Unknown",
      stake,
      payout,
      profit,
      multiplier: (d.payoutMultiplier != null) ? Number(d.payoutMultiplier) : null,
      currency: d.currency || "",
      date: dateObj ? dateObj.toISOString() : null
    };
  }

  function renderTopWins(records){
    const wins = records.filter(r => r.profit > 0)
                        .sort((a,b)=> b.profit - a.profit)
                        .slice(0,25);
    const tbody = document.getElementById("winsBody");
    tbody.innerHTML = "";
    wins.forEach((w,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${w.date ? new Date(w.date).toLocaleString() : "—"}</td>
        <td>${w.game}</td>
        <td>${w.stake.toFixed(6)}</td>
        <td>${w.payout.toFixed(6)}</td>
        <td class="positive">${w.profit.toFixed(6)}</td>
        <td>${w.multiplier !== null ? w.multiplier.toFixed(2)+"x" : "—"}</td>
        <td>${w.currency}</td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById("winsTable").style.display = wins.length ? "table" : "none";
  }

  // --- NEW: sequential file processing ---
  async function processFilesSequentially(fileList){
    const parsed = [];
    for (const f of fileList){
      try{
        const txt = await f.text();
        const json = JSON.parse(txt);
        if (Array.isArray(json)) {
          json.forEach(item => parsed.push(normalizeRecord(item)));
        }
      }catch(e){
        console.error("Parse fail", f.name, e);
      }
    }
    return parsed;
  }

  document.getElementById("fileInput").addEventListener("change", async ev=>{
    const files = ev.target.files;
    if (!files.length) return;

    alert("Processing "+files.length+" files. This may take a while… keep the tab open.");
    const parsed = await processFilesSequentially(files);
    console.log("Parsed records:", parsed.length);

    if (parsed.length) {
      const current = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
      const merged = current.concat(parsed);
      localStorage.setItem(LS_KEY, JSON.stringify(merged));
      alert("Uploaded "+parsed.length+" bets. Now click 'Load Data'.");
    } else {
      alert("No bets parsed. Check console for errors.");
    }
  });

  document.getElementById("btnLoad").addEventListener("click", ()=>{
    const saved = localStorage.getItem(LS_KEY);
    if (saved){
      try{ renderTopWins(JSON.parse(saved)); }catch(e){ console.error(e); }
    } else {
      alert("No data found. Please upload JSON files first.");
    }
  });

  document.getElementById("btnClear").addEventListener("click", ()=>{
    localStorage.removeItem(LS_KEY);
    document.getElementById("winsBody").innerHTML = "";
    document.getElementById("winsTable").style.display = "none";
    alert("All stored data cleared.");
  });
});
</script>
